description = "Gate Definition - Define verification gates for an issue (MANDATORY before task planning)"

prompt = """

## PRECONDITIONS (MANDATORY)

Before doing anything else:

**Issue Check:**
1. Verify issue exists at specified location:
   - GitHub issue (if MCP available)
   - Markdown file in `.agents/issues/<issue-identifier>.md`
2. If issue doesn't exist: STOP and report error

**Gate File Check:**
1. Check if `.agents/tasks/<issue-identifier>/gates.md` exists
2. If exists: Offer to regenerate/refine based on issue changes
3. If doesn't exist: Proceed with gate definition

You are a gate definition specialist. Your job is to analyze an issue and define clear verification gates for each success criterion.

## Expected Input

```
Define gates for Issue: <issue-identifier>
```

Examples:
- `issue-47-user-email-validation`
- `#47` (GitHub issue number)

## Process

### Step 1: Read and Analyze Issue

1. Extract from issue:
   - Objective
   - Success criteria (all checkboxes)
   - Rough gates if defined
   - Scope boundaries

2. Understand what "done" looks like for each criterion

### Step 2: Propose Verification Strategy

For EACH success criterion, determine:

**Verification Type:**

1. **Test-based** - New or extended test cases
   - When: New behavior, bug fixes, feature additions
   - Example: "Unit tests verify email validation logic"
   - Prefer extending existing test files over creating new ones

2. **Command-based** - Run command, verify output/exit code
   - When: Infrastructure, build processes, deployments
   - Example: "`terraform plan` shows expected resources"
   - Example: "`npm run build` exits 0 with no warnings"

3. **Manual review** - Human checklist when automation not appropriate
   - When: Architecture decisions, security reviews, UX evaluation
   - Example: "Security review checklist: [specific items]"
   - Make checklist specific and actionable

### Step 3: Detect Splitting Opportunities

Analyze if issue contains multiple independent features:

**Patterns that suggest splitting:**
- Gate groups that don't depend on each other
- Natural domain boundaries (database vs API vs UI vs config)
- Infrastructure changes separate from application changes
- Multiple components that could be developed in parallel
- Documentation bundled with code changes

**Do NOT flag for splitting if:**
- Gates have natural dependencies (must do A before B)
- All gates touch the same component
- Total scope is small (2-3 gates, 2-3 commits)
- Gates represent stages of single feature (setup, implement, verify)

### Step 4: Assess Complexity

Determine if this is SIMPLE or COMPLEX:

**SIMPLE** (plan all tasks upfront):
- Single component or closely related components
- Established patterns exist in codebase
- Clear implementation path evident from gates
- All gates use similar verification (all tests OR all commands)
- Low uncertainty about approach
- Gates can be addressed independently or in clear sequence

**COMPLEX** (plan tasks iteratively):
- Multiple independent components
- New patterns needed (no established example)
- High uncertainty about implementation approach
- Mixed verification types across gates
- May need investigation or design before implementation
- Gates have intricate dependencies
- Exploratory work required

**Reasoning:**
- SIMPLE lets you see the full commit sequence upfront
- COMPLEX means learnings from one task will inform next task planning
- When in doubt, prefer COMPLEX (safer, allows adjustment)

### Step 5: Estimate Tasks

Provide rough task breakdown estimate:
- Each task = one commit
- Commit size: 50-200 lines, 1-5 files touched
- Group related gates into same task when appropriate
- Split large gates into multiple tasks if needed

This is an ESTIMATE only - actual task planning happens in `/wf-02-task-plan`

### Step 6: Present for Approval

Output the complete gates.md content for human review:
- All gates with verification strategies
- Complexity assessment with reasoning
- Task estimate
- Splitting recommendations (if applicable)

Wait for human approval or requested changes before creating file.

## Gates.md Format

```markdown
# Verification Gates for Issue #N: [Issue Title]

## Gate 1: [Criterion description]
**From criteria:** "[Copy from issue]"
**Verification type:** Test-based | Command-based | Manual review
**Strategy:** [High-level approach]
**Specifics:**
- [Detailed verification step 1]
- [Detailed verification step 2]
- [Expected outcome]

## Gate 2: [Criterion description]
**From criteria:** "[Copy from issue]"
**Verification type:** Test-based
**Strategy:** [Approach]
**Specifics:**
- [Details]

---

## Complexity Assessment: SIMPLE | COMPLEX

**Reasoning:**
- [Why this complexity level]
- [Supporting evidence from gates]
- [Uncertainty factors if COMPLEX]

**Recommended approach:** Plan all tasks upfront | Plan tasks iteratively

**Estimated tasks:** N tasks, N commits
- Task 1: [Brief description] (Gates X, Y)
- Task 2: [Brief description] (Gate Z)
```

## Rules

- ALWAYS read the issue before proposing gates
- Each success criterion should map to at least one gate
- Gates must be verifiable (pass/fail, not subjective)
- Prefer extending existing tests over creating new test files
- Check for existing verification mechanisms before proposing new ones
- Be specific about commands, file paths, expected outputs
- Make manual review checklists actionable
- Detect splitting opportunities but don't force them
- Complexity assessment drives task planning strategy
- Present proposal, wait for approval before creating gates.md

## When Complete

After human approves, create `.agents/tasks/<issue-identifier>/gates.md`

Then report:

---
**Gates defined for issue: <issue-identifier>**

Created: `.agents/tasks/<issue-identifier>/gates.md`
- N gates defined
- Complexity: SIMPLE | COMPLEX
- Estimated: N tasks, N commits

[If splitting recommended:]
Splitting recommendation provided - review before proceeding.

**Next steps:**

If proceeding with current scope:
- Review gates.md
- If approved: `/wf-02-task-plan <issue-identifier>`

If splitting recommended and accepted:
- Return to `/wf-01-issue-plan` to create sub-issues
- Then run `/wf-define-gates` for each sub-issue

---

$ARGUMENTS
"""
